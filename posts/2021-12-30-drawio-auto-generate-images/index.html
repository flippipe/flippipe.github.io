<!doctype html><html lang=en dir=auto>
<head><meta charset=utf-8>
<meta http-equiv=x-ua-compatible content="IE=edge">
<meta name=viewport content="width=device-width,initial-scale=1,shrink-to-fit=no">
<meta name=robots content="index, follow">
<title>draw.io - Auto Generate Images | œú’¨◊ïœÅ Œ°Œπ—ÄŒµ</title>
<meta name=keywords content="git,draw.io">
<meta name=description content="I got a new assignment and it involves creating diagrams with drawio. As the diagrams will be used in documentation and exposed in GitHub, I need updated images automatically.">
<meta name=author content="Filipe">
<link rel=canonical href=https://flippipe.github.io/posts/2021-12-30-drawio-auto-generate-images/>
<link crossorigin=anonymous href=/assets/css/stylesheet.min.c88963fe2d79462000fd0fb1b3737783c32855d340583e4523343f8735c787f0.css integrity="sha256-yIlj/i15RiAA/Q+xs3N3g8MoVdNAWD5FIzQ/hzXHh/A=" rel="preload stylesheet" as=style>
<script defer crossorigin=anonymous src=/assets/js/highlight.min.7680afc38aa6b15ddf158a4f3780b7b1f7dde7e91d26f073e6229bb7a0793c92.js integrity="sha256-doCvw4qmsV3fFYpPN4C3sffd5+kdJvBz5iKbt6B5PJI=" onload=hljs.initHighlightingOnLoad()></script>
<link rel=icon href=https://flippipe.github.io/favicon.ico>
<link rel=icon type=image/png sizes=16x16 href=https://flippipe.github.io/favicon-16x16.png>
<link rel=icon type=image/png sizes=32x32 href=https://flippipe.github.io/favicon-32x32.png>
<link rel=apple-touch-icon href=https://flippipe.github.io/apple-touch-icon.png>
<link rel=mask-icon href=https://flippipe.github.io/safari-pinned-tab.svg>
<meta name=theme-color content="#2e2e33">
<meta name=msapplication-TileColor content="#2e2e33">
<meta name=generator content="Hugo 0.92.0">
<noscript>
<style>#theme-toggle,.top-link{display:none}</style>
<style>@media(prefers-color-scheme:dark){:root{--theme:rgb(29, 30, 32);--entry:rgb(46, 46, 51);--primary:rgb(218, 218, 219);--secondary:rgb(155, 156, 157);--tertiary:rgb(65, 66, 68);--content:rgb(196, 196, 197);--hljs-bg:rgb(46, 46, 51);--code-bg:rgb(55, 56, 62);--border:rgb(51, 51, 51)}.list{background:var(--theme)}.list:not(.dark)::-webkit-scrollbar-track{background:0 0}.list:not(.dark)::-webkit-scrollbar-thumb{border-color:var(--theme)}}</style>
</noscript><meta property="og:title" content="draw.io - Auto Generate Images">
<meta property="og:description" content="I got a new assignment and it involves creating diagrams with drawio. As the diagrams will be used in documentation and exposed in GitHub, I need updated images automatically.">
<meta property="og:type" content="article">
<meta property="og:url" content="https://flippipe.github.io/posts/2021-12-30-drawio-auto-generate-images/"><meta property="article:section" content="posts">
<meta property="article:published_time" content="2021-12-30T21:20:30+00:00">
<meta property="article:modified_time" content="2021-12-30T21:20:30+00:00"><meta property="og:site_name" content="œú’¨◊ïœÅ Œ°Œπ—ÄŒµ">
<meta name=twitter:card content="summary">
<meta name=twitter:title content="draw.io - Auto Generate Images">
<meta name=twitter:description content="I got a new assignment and it involves creating diagrams with drawio. As the diagrams will be used in documentation and exposed in GitHub, I need updated images automatically.">
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":2,"name":"Posts","item":"https://flippipe.github.io/posts/"},{"@type":"ListItem","position":3,"name":"draw.io - Auto Generate Images","item":"https://flippipe.github.io/posts/2021-12-30-drawio-auto-generate-images/"}]}</script>
<script type=application/ld+json>{"@context":"https://schema.org","@type":"BlogPosting","headline":"draw.io - Auto Generate Images","name":"draw.io - Auto Generate Images","description":"I got a new assignment and it involves creating diagrams with drawio. As the diagrams will be used in documentation and exposed in GitHub, I need updated images automatically.","keywords":["git","draw.io"],"articleBody":"TLDR Applications in snaps running script to call other electron snapped application do not mix well.\nFinal solution, was use old tools like incrond to captures the changes in the diagrams to auto generate the files.\nStory üí° My first thought was to create a GitHub Action to generate these files, but actions-drawio is based in code it is archived, because drawio-desktop already supports command line interface to export to image formats.\nSome time ago, skimming git documentation I saw references for hooks and this time, was a good time to try it out. Each time I commit a new diagram, it will auto generate a new image.\nIt could not to be to difficult to do a simple script to do this task‚Ä¶ and‚Ä¶ oh god! how wrong I was.\nHurdle ‚ë† - Snap Confinement and drawio-desktop Snap Confinement is good for the security of our computers, but, it expects users have their files in the default locations, and, almost all my files are not.\nSo I try to use the trick to remount my working directory inside /mnt to allow snap removable-media interface to use it, but no luck.\n$ sudo snap connections drawio | grep removable-media $  Solution Modify the snap to add the removable-media interface\n$ snap download drawio $ unsquashfs -dest drawio_138 drawio_138.snap Edit drawio_138/meta/snap.yaml and add removable-media into plugs\nResulting in something like:\napps: drawio: command: command.sh plugs: (...) - opengl - removable-media environment: Then, use the modified snap with snap try\n$ sudo snap try drawio_138 Snap, installed\n$ snap list Name Version Rev Tracking Publisher Notes core20 20211129 1270 latest/stable canonical‚úì base drawio 16.0.2 x1 - - try Last task, mount the directory in the new location, adapted from Home directories outside of ‚Äò/home‚Äô\n# mount --bind /work/WIP/ /mnt/WIP/  Hurdle ‚ë° - Git Hooks I‚Äôm new to git, so, choose the right hook to do the task, was not easy‚Ä¶ some voices in internet, say to use pre-commit, but adding files at this stage is not linear.\nMy chosen solution was to do a post-commit, in which will generate the file and then add and commit the file. Something like:\n/snap/bin/drawio --export git add git commit -m \"AutoCommit - Update DrawIO Images\" I made the script work when I manually ran git commit on terminal‚Ä¶ but when the hook ran inside VSCodium‚Ä¶ it didn‚Äôt work‚Ä¶\nHurdle ‚ë¢ - Electron‚Ä¶ Snaps‚Ä¶ From inside an Electron App (VSCodium) try to run another Electron App (drawio-desktop), was an hell, so I quit to make it work.\nJust a quick note, if you see something like this in your system logs\nkernel: traps: drawio[767435] trap int3 ip:55fac191b086 sp:7ffe0bb228d0 error:0 in drawio[55fac0bcb000+6a10000] Consider it as a core dump.\nHurdle ‚ë£ - No Git Hooks Without git hooks, I need to find a solution to detect file changes, and inotify kernel feature is a great solution, but lack a good user land tools.\ninotifywait paired with while, as many solutions out there, was not an option‚Ä¶\nJust found to possible paths:\n incron systemd.path  incron   üëç Already use it on other project and it simple to use\n  üëéüèº mask special symbol do not work: dotdirs, loopable and recursive,\n  üëéüèº Security problems\n  üëéüèº Project stalled\n  systemd.path  üëç I would like to use StartLimitIntervalSec and StartLimitBurst, because, drawio-desktop after each change saves the file. üëéüèº How to tell which PathChanged?  Do not have an option to have the name of the modified file, kills the possibility to use systemd.path, I do not know how many files and directories I will have in the end, and manage all manually, will kill the agility.\nSo in the end, I just have the option of incron üòí\nHurdle ‚ë§ - Electron is not meant to run on headless Electron apps are made to be used in a graphical environment, not to be used in a script.\nBut fortunately, someone use CICD process to test their electron app already have that problem solved.\nMeanwhile, feature request in electron is not done, we have an option to create a Xvfb\nSolution Install and configure incron This is the easiest part\n$ sudo apt install incron Then, add your username to /etc/incron.allow\nDeploy user configurations Edit incrontab\n$ incrontab -e and add your configuration\n/work/WIP/Clouds/*.drawio IN_CLOSE_WRITE /home/johndoe/bin/incron-drawio.sh $@ Then create your script /home/johndoe/bin/incron-drawio.sh\nMy Script #!/bin/bash set -Eeuo pipefail # because drawio runs as a snap, it can not access the real location of the file # to be changed as needed realFile=$( readlink -f \"$1\" | sed \"s#/work#/mnt#\" ) lastChange=$(stat --format=\"%Y\" \"${realFile%.*}\".png) now=$(date +\"%s\") delta=$(( now - lastChange )) # drawio saves file each time it move an item... ignore changes below 30 seconds [ $delta -lt 30 ] \u0026\u0026 exit echo \"incron generating image from $1\" | logger # drawio is an electron app, and expect to have a display server # so, use a framebuffer without GPU export DISPLAY=':99.0' Xvfb :99 -screen 0 1024x768x24  /dev/null 2\u00261 \u0026 Xvfb_PID=$! drawio='/snap/bin/drawio --export --width 1024 --border 10' $drawio --output \"${realFile%.*}\".png \"$realFile\" | logger kill $Xvfb_PID üç¨ Some other resources how help me in this journey\n Git Hooks incron incrontab - tables for driving inotify cron (incron)  ","wordCount":"860","inLanguage":"en","datePublished":"2021-12-30T21:20:30Z","dateModified":"2021-12-30T21:20:30Z","author":{"@type":"Person","name":"Filipe"},"mainEntityOfPage":{"@type":"WebPage","@id":"https://flippipe.github.io/posts/2021-12-30-drawio-auto-generate-images/"},"publisher":{"@type":"Organization","name":"œú’¨◊ïœÅ Œ°Œπ—ÄŒµ","logo":{"@type":"ImageObject","url":"https://flippipe.github.io/favicon.ico"}}}</script>
</head>
<body id=top>
<script>localStorage.getItem("pref-theme")==="dark"?document.body.classList.add('dark'):localStorage.getItem("pref-theme")==="light"?document.body.classList.remove('dark'):window.matchMedia('(prefers-color-scheme: dark)').matches&&document.body.classList.add('dark')</script>
<header class=header>
<nav class=nav>
<div class=logo>
<a href=https://flippipe.github.io accesskey=h title="œú’¨◊ïœÅ Œ°Œπ—ÄŒµ (Alt + H)">œú’¨◊ïœÅ Œ°Œπ—ÄŒµ</a>
<span class=logo-switches>
<button id=theme-toggle accesskey=t title="(Alt + T)"><svg id="moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M21 12.79A9 9 0 1111.21 3 7 7 0 0021 12.79z"/></svg><svg id="sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentcolor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="5"/><line x1="12" y1="1" x2="12" y2="3"/><line x1="12" y1="21" x2="12" y2="23"/><line x1="4.22" y1="4.22" x2="5.64" y2="5.64"/><line x1="18.36" y1="18.36" x2="19.78" y2="19.78"/><line x1="1" y1="12" x2="3" y2="12"/><line x1="21" y1="12" x2="23" y2="12"/><line x1="4.22" y1="19.78" x2="5.64" y2="18.36"/><line x1="18.36" y1="5.64" x2="19.78" y2="4.22"/></svg>
</button>
</span>
</div>
<ul id=menu>
<li>
<a href=https://flippipe.github.io/posts/ title=posts>
<span>posts</span>
</a>
</li>
<li>
<a href=https://flippipe.github.io/categories/ title=categories>
<span>categories</span>
</a>
</li>
<li>
<a href=https://flippipe.github.io/tags/ title=tags>
<span>tags</span>
</a>
</li>
<li>
<a href=https://flippipe.github.io/mix/playlist/ title=üéß>
<span>üéß</span>
</a>
</li>
</ul>
</nav>
</header>
<main class=main>
<article class=post-single>
<header class=post-header>
<div class=breadcrumbs><a href=https://flippipe.github.io>Home</a>&nbsp;¬ª&nbsp;<a href=https://flippipe.github.io/posts/>Posts</a></div>
<h1 class=post-title>
draw.io - Auto Generate Images
</h1>
<div class=post-description>
I got a new assignment and it involves creating diagrams with drawio. As the diagrams will be used in documentation and exposed in GitHub, I need updated images automatically.
</div>
<div class=post-meta><span title="2021-12-30 21:20:30 +0000 UTC">30 Dec 2021</span>&nbsp;¬∑&nbsp;5 min&nbsp;¬∑&nbsp;Filipe&nbsp;|&nbsp;<a href=https://github.com/flippipe/flippipe.github.io/blob/master/content/posts/2021-12-30-drawio-auto-generate-images.md rel="noopener noreferrer" target=_blank>Suggest Changes</a>
</div>
</header>
<div class=post-content><h1 id=tldr>TLDR<a hidden class=anchor aria-hidden=true href=#tldr>#</a></h1>
<p>Applications in <a href=https://en.wikipedia.org/wiki/Snap_(package_manager)>snaps</a> running script to call other <a href=https://www.electronjs.org/docs/latest>electron</a> snapped application do not mix well.</p>
<p><a href=#solution-1>Final solution</a>, was use old tools like <a href=https://github.com/ar-/incron>incrond</a> to captures the changes in the diagrams to auto generate the files.</p>
<h1 id=story>Story<a hidden class=anchor aria-hidden=true href=#story>#</a></h1>
<h2 id=heading>üí°<a hidden class=anchor aria-hidden=true href=#heading>#</a></h2>
<p>My first thought was to create a GitHub Action to generate these files, but <a href=https://github.com/marketplace/actions/actions-drawio>actions-drawio</a> is based in code it is <a href=https://github.com/languitar/drawio-batch>archived</a>, because drawio-desktop already <a href=https://j2r2b.github.io/2019/08/06/drawio-cli.html>supports</a> command line interface to export to image formats.</p>
<p>Some time ago, skimming <a href=https://git-scm.com/book/en/v2>git</a> documentation I saw references for hooks and this time, was a good time to try it out. Each time I commit a new diagram, it will auto generate a new image.</p>
<p>It could not to be to difficult to do a simple script to do this task&mldr; and&mldr; oh god! how wrong I was.</p>
<h2 id=hurdle----snap-confinement-and-drawio-desktop>Hurdle ‚ë† - Snap Confinement and drawio-desktop<a hidden class=anchor aria-hidden=true href=#hurdle----snap-confinement-and-drawio-desktop>#</a></h2>
<p><a href=https://snapcraft.io/blog/demystifying-snap-confinement>Snap Confinement</a> is good for the security of our computers, but, it expects users have their files in the default locations, and, almost all my files are not.</p>
<p>So I try to use the trick to remount my working directory inside <code>/mnt</code> to allow snap <a href=https://snapcraft.io/docs/removable-media-interface>removable-media interface</a> to use it, but no luck.</p>
<pre><code>$ sudo snap connections drawio | grep removable-media
$
</code></pre>
<h3 id=solution>Solution<a hidden class=anchor aria-hidden=true href=#solution>#</a></h3>
<p>Modify the snap to add the <code>removable-media</code> interface</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ snap download drawio
$ unsquashfs -dest drawio_138 drawio_138.snap
</code></pre></div><p>Edit <code>drawio_138/meta/snap.yaml</code> and add <code>removable-media</code> into plugs</p>
<p>Resulting in something like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-yaml data-lang=yaml><span style=color:#f92672>apps</span>:
<span style=color:#f92672>drawio</span>:
    <span style=color:#f92672>command</span>: <span style=color:#ae81ff>command.sh</span>
    <span style=color:#f92672>plugs</span>:
        <span style=color:#ae81ff>(...)</span>
        - <span style=color:#ae81ff>opengl</span>
        - <span style=color:#ae81ff>removable-media</span>
    <span style=color:#f92672>environment</span>:
</code></pre></div><p>Then, use the modified snap with <a href=https://snapcraft.io/docs/snap-try#heading--snaptry><code>snap try</code></a></p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo snap try drawio_138
</code></pre></div><p>Snap, installed</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ snap list 
Name                             Version                     Rev    Tracking         Publisher          Notes
core20                           <span style=color:#ae81ff>20211129</span>                    <span style=color:#ae81ff>1270</span>   latest/stable    canonical‚úì         base
drawio                           16.0.2                      x1     -                -                  try
</code></pre></div><p>Last task, <code>mount</code> the directory in the new location, adapted from <a href=https://snapcraft.io/docs/home-outside-home>Home directories outside of &lsquo;/home&rsquo;</a></p>
<pre><code># mount --bind  /work/WIP/ /mnt/WIP/
</code></pre>
<h2 id=hurdle----git-hooks>Hurdle ‚ë° - Git Hooks<a hidden class=anchor aria-hidden=true href=#hurdle----git-hooks>#</a></h2>
<p>I&rsquo;m new to git, so, choose the right <a href=https://git-scm.com/book/en/v2/Customizing-Git-Git-Hooks>hook</a> to do the task, was not easy&mldr; some voices in internet, say to use <code>pre-commit</code>, but adding files at this stage is not linear.</p>
<p>My chosen solution was to do a <code>post-commit</code>, in which will generate the file and then add and commit the file. Something like:</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>/snap/bin/drawio --export 
git add
git commit -m <span style=color:#e6db74>&#34;AutoCommit - Update DrawIO Images&#34;</span> 
</code></pre></div><p>I made the script work when I manually ran <code>git commit</code> on terminal&mldr; but when the hook ran inside <a href=https://vscodium.com/>VSCodium</a>&mldr; it didn&rsquo;t work&mldr;</p>
<h2 id=hurdle----electron-snaps>Hurdle ‚ë¢ - Electron&mldr; Snaps&mldr;<a hidden class=anchor aria-hidden=true href=#hurdle----electron-snaps>#</a></h2>
<p>From inside an Electron App (VSCodium) try to run another Electron App (drawio-desktop), was an hell, so I quit to make it work.</p>
<p>Just a quick note, if you see something like this in your system logs</p>
<pre tabindex=0><code class=language-log data-lang=log>kernel: traps: drawio[767435] trap int3 ip:55fac191b086 sp:7ffe0bb228d0 error:0 in drawio[55fac0bcb000+6a10000]
</code></pre><p>Consider it as a core dump.</p>
<h2 id=hurdle----no-git-hooks>Hurdle ‚ë£ - No Git Hooks<a hidden class=anchor aria-hidden=true href=#hurdle----no-git-hooks>#</a></h2>
<p>Without git hooks, I need to find a solution to detect file changes, and inotify kernel feature is a great solution, but lack a good user land tools.</p>
<p><a href=https://github.com/inotify-tools/inotify-tools>inotifywait</a> paired with while, as many <a href=https://unix.stackexchange.com/a/323919>solutions</a> out there, was not an option&mldr;</p>
<p>Just found to possible paths:</p>
<ul>
<li><a href=https://github.com/ar-/incron>incron</a></li>
<li><a href=https://www.freedesktop.org/software/systemd/man/systemd.path.html#>systemd.path</a></li>
</ul>
<h3 id=incron>incron<a hidden class=anchor aria-hidden=true href=#incron>#</a></h3>
<ul>
<li>
<p>üëç Already use it on other project and it simple to use</p>
</li>
<li>
<p>üëéüèº mask special symbol do not work: <a href=https://github.com/ar-/incron/issues/57>dotdirs</a>, <a href=https://github.com/ar-/incron/issues/77>loopable</a> and <a href=https://github.com/ar-/incron/issues/78>recursive</a>,</p>
</li>
<li>
<p>üëéüèº Security <a href=https://github.com/ar-/incron/issues/35>problems</a></p>
</li>
<li>
<p>üëéüèº Project <a href=https://github.com/ar-/incron/issues/68>stalled</a></p>
</li>
</ul>
<h3 id=systemdpath>systemd.path<a hidden class=anchor aria-hidden=true href=#systemdpath>#</a></h3>
<ul>
<li>üëç I would like to use <code>StartLimitIntervalSec</code> and <code>StartLimitBurst</code>, because, drawio-desktop after each change saves the file.</li>
<li>üëéüèº <a href=https://unix.stackexchange.com/questions/600642/systemd-path-how-to-tell-which-pathchanged>How to tell which PathChanged?</a></li>
</ul>
<p>Do not have an option to have the name of the modified file, kills the possibility to use <code>systemd.path</code>, I do not know how many files and directories I will have in the end, and manage all manually, will kill the agility.</p>
<p>So in the end, I just have the option of <code>incron</code> üòí</p>
<h2 id=hurdle----electron-is-not-meant-to-run-on-headless>Hurdle ‚ë§ - Electron is not meant to run on headless<a hidden class=anchor aria-hidden=true href=#hurdle----electron-is-not-meant-to-run-on-headless>#</a></h2>
<p>Electron apps are made to be used in a graphical environment, not to be used in a script.</p>
<p>But fortunately, someone use CICD process to test their electron app already have that <a href=https://webuild.envato.com/blog/running-headless-javascript-testing-with-electron-on-any-ci-server/>problem</a> solved.</p>
<p>Meanwhile, <a href=https://github.com/electron/electron/issues/228>feature</a> request in electron is not done, we have an option to create a <a href=https://www.x.org/releases/X11R7.6/doc/man/man1/Xvfb.1.xhtml#heading6>Xvfb</a></p>
<h1 id=solution-1>Solution<a hidden class=anchor aria-hidden=true href=#solution-1>#</a></h1>
<h2 id=install-and-configure-incron>Install and configure incron<a hidden class=anchor aria-hidden=true href=#install-and-configure-incron>#</a></h2>
<p>This is the easiest part</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ sudo apt install incron
</code></pre></div><p>Then, add your username to <code>/etc/incron.allow</code></p>
<h2 id=deploy-user-configurations>Deploy user configurations<a hidden class=anchor aria-hidden=true href=#deploy-user-configurations>#</a></h2>
<p>Edit incrontab</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-shell data-lang=shell>$ incrontab -e
</code></pre></div><p>and add your configuration</p>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-txt data-lang=txt>/work/WIP/Clouds/*.drawio  IN_CLOSE_WRITE  /home/johndoe/bin/incron-drawio.sh $@
</code></pre></div><p>Then create your script <code>/home/johndoe/bin/incron-drawio.sh</code></p>
<h2 id=my-script>My Script<a hidden class=anchor aria-hidden=true href=#my-script>#</a></h2>
<div class=highlight><pre tabindex=0 style=color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-bash data-lang=bash><span style=color:#75715e>#!/bin/bash
</span><span style=color:#75715e></span>set -Eeuo pipefail

<span style=color:#75715e># because drawio runs as a snap, it can not access the real location of the file</span>
<span style=color:#75715e># to be changed as needed</span>
realFile<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span> readlink -f <span style=color:#e6db74>&#34;</span>$1<span style=color:#e6db74>&#34;</span> | sed <span style=color:#e6db74>&#34;s#/work#/mnt#&#34;</span> <span style=color:#66d9ef>)</span>

lastChange<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>stat --format<span style=color:#f92672>=</span><span style=color:#e6db74>&#34;%Y&#34;</span> <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>realFile%.*<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>.png<span style=color:#66d9ef>)</span>
now<span style=color:#f92672>=</span><span style=color:#66d9ef>$(</span>date +<span style=color:#e6db74>&#34;%s&#34;</span><span style=color:#66d9ef>)</span>
delta<span style=color:#f92672>=</span><span style=color:#66d9ef>$((</span> now <span style=color:#f92672>-</span> lastChange <span style=color:#66d9ef>))</span>

<span style=color:#75715e># drawio saves file each time it move an item... ignore changes below 30 seconds</span>
<span style=color:#f92672>[</span> $delta -lt <span style=color:#ae81ff>30</span> <span style=color:#f92672>]</span> <span style=color:#f92672>&amp;&amp;</span> exit

echo <span style=color:#e6db74>&#34;incron generating image from </span>$1<span style=color:#e6db74>&#34;</span> | logger 

<span style=color:#75715e># drawio is an electron app, and expect to have a display server</span>
<span style=color:#75715e># so, use a framebuffer without GPU</span>
export DISPLAY<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;:99.0&#39;</span>
Xvfb :99 -screen <span style=color:#ae81ff>0</span> 1024x768x24 &gt; /dev/null 2&gt;&amp;<span style=color:#ae81ff>1</span> &amp;
Xvfb_PID<span style=color:#f92672>=</span>$!

drawio<span style=color:#f92672>=</span><span style=color:#e6db74>&#39;/snap/bin/drawio --export --width 1024 --border 10&#39;</span>
$drawio --output <span style=color:#e6db74>&#34;</span><span style=color:#e6db74>${</span>realFile%.*<span style=color:#e6db74>}</span><span style=color:#e6db74>&#34;</span>.png <span style=color:#e6db74>&#34;</span>$realFile<span style=color:#e6db74>&#34;</span> | logger 

kill $Xvfb_PID

</code></pre></div><h1 id=heading-1>üç¨<a hidden class=anchor aria-hidden=true href=#heading-1>#</a></h1>
<p>Some other resources how help me in this journey</p>
<ul>
<li><a href=https://githooks.com/>Git Hooks</a></li>
<li><a href=https://wiki.archlinux.org/title/Incron>incron</a></li>
<li><a href=https://man.archlinux.org/man/incrontab.5>incrontab - tables for driving inotify cron (incron)</a></li>
</ul>
</div>
<footer class=post-footer>
<ul class=post-tags>
<li><a href=https://flippipe.github.io/tags/git/>git</a></li>
<li><a href=https://flippipe.github.io/tags/draw.io/>draw.io</a></li>
</ul>
<div class=share-buttons>
<a target=_blank rel="noopener noreferrer" aria-label="share draw.io - Auto Generate Images on telegram" href="https://telegram.me/share/url?text=draw.io%20-%20Auto%20Generate%20Images&url=https%3a%2f%2fflippipe.github.io%2fposts%2f2021-12-30-drawio-auto-generate-images%2f"><svg viewBox="2 2 28 28"><path d="M26.49 29.86H5.5a3.37 3.37.0 01-2.47-1 3.35 3.35.0 01-1-2.47V5.48A3.36 3.36.0 013 3 3.37 3.37.0 015.5 2h21A3.38 3.38.0 0129 3a3.36 3.36.0 011 2.46V26.37a3.35 3.35.0 01-1 2.47 3.38 3.38.0 01-2.51 1.02zm-5.38-6.71a.79.79.0 00.85-.66L24.73 9.24a.55.55.0 00-.18-.46.62.62.0 00-.41-.17q-.08.0-16.53 6.11a.59.59.0 00-.41.59.57.57.0 00.43.52l4 1.24 1.61 4.83a.62.62.0 00.63.43.56.56.0 00.4-.17L16.54 20l4.09 3A.9.9.0 0021.11 23.15zM13.8 20.71l-1.21-4q8.72-5.55 8.78-5.55c.15.0.23.0.23.16a.18.18.0 010 .06s-2.51 2.3-7.52 6.8z"/></svg>
</a>
</div>
</footer>
</article>
</main>
<footer class=footer>
<span>&copy; 2022 <a href=https://flippipe.github.io>œú’¨◊ïœÅ Œ°Œπ—ÄŒµ</a></span>
<span>
Powered by
<a href=https://gohugo.io/ rel="noopener noreferrer" target=_blank>Hugo</a> &
        <a href=https://git.io/hugopapermod rel=noopener target=_blank>PaperMod</a>
</span>
</footer>
<a href=#top aria-label="go to top" title="Go to Top (Alt + G)" class=top-link id=top-link accesskey=g><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 12 6" fill="currentcolor"><path d="M12 6H0l6-6z"/></svg>
</a>
<script>let menu=document.getElementById('menu');menu&&(menu.scrollLeft=localStorage.getItem("menu-scroll-position"),menu.onscroll=function(){localStorage.setItem("menu-scroll-position",menu.scrollLeft)}),document.querySelectorAll('a[href^="#"]').forEach(a=>{a.addEventListener("click",function(b){b.preventDefault();var a=this.getAttribute("href").substr(1);window.matchMedia('(prefers-reduced-motion: reduce)').matches?document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView():document.querySelector(`[id='${decodeURIComponent(a)}']`).scrollIntoView({behavior:"smooth"}),a==="top"?history.replaceState(null,null," "):history.pushState(null,null,`#${a}`)})})</script>
<script>var mybutton=document.getElementById("top-link");window.onscroll=function(){document.body.scrollTop>800||document.documentElement.scrollTop>800?(mybutton.style.visibility="visible",mybutton.style.opacity="1"):(mybutton.style.visibility="hidden",mybutton.style.opacity="0")}</script>
<script>document.getElementById("theme-toggle").addEventListener("click",()=>{document.body.className.includes("dark")?(document.body.classList.remove('dark'),localStorage.setItem("pref-theme",'light')):(document.body.classList.add('dark'),localStorage.setItem("pref-theme",'dark'))})</script>
<script>document.querySelectorAll('pre > code').forEach(b=>{const c=b.parentNode.parentNode,a=document.createElement('button');a.classList.add('copy-code'),a.innerText='copy';function d(){a.innerText='copied!',setTimeout(()=>{a.innerText='copy'},2e3)}a.addEventListener('click',e=>{if('clipboard'in navigator){navigator.clipboard.writeText(b.textContent),d();return}const a=document.createRange();a.selectNodeContents(b);const c=window.getSelection();c.removeAllRanges(),c.addRange(a);try{document.execCommand('copy'),d()}catch(a){}c.removeRange(a)}),c.classList.contains("highlight")?c.appendChild(a):c.parentNode.firstChild==c||(b.parentNode.parentNode.parentNode.parentNode.parentNode.nodeName=="TABLE"?b.parentNode.parentNode.parentNode.parentNode.parentNode.appendChild(a):b.parentNode.appendChild(a))})</script>
</body>
</html>